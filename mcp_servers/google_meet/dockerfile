FROM python:3.12-slim AS base

ENV PYTHONUNBUFFERED=1 \
	PIP_NO_CACHE_DIR=1 \
	PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

RUN apt-get update \
	&& apt-get install -y --no-install-recommends ca-certificates curl \
	&& rm -rf /var/lib/apt/lists/*

COPY requirements.txt ./mcp_servers/google_meet/requirements.txt
WORKDIR /app/mcp_servers/google_meet
RUN pip install --no-cache-dir -r requirements.txt

COPY . /app

RUN useradd -m appuser && chown -R appuser /app
USER appuser

ENV GOOGLE_MEET_MCP_SERVER_PORT=5000 \
	LOG_LEVEL=INFO

EXPOSE 5000

HEALTHCHECK --interval=30s --timeout=3s --retries=3 CMD ["python","-c","import socket,os,sys;port=int(os.getenv('GOOGLE_MEET_MCP_SERVER_PORT','5000'));s=socket.socket();s.settimeout(2);\n\nimport contextlib;\ntry:\n s.connect(('127.0.0.1',port))\nexcept Exception as e:\n print('healthcheck fail',e);sys.exit(1)\nfinally:\n s.close();print('ok')"]

ENTRYPOINT ["python","server.py","--port","5000","--log-level","INFO"]
